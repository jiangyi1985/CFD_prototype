<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>ASP.NET SignalR Stock Ticker</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, Helvetica, sans-serif;
            font-size: 16px;
        }

        #stockTable table {
            border-collapse: collapse;
        }

            #stockTable table th, #stockTable table td {
                padding: 2px 6px;
            }

            #stockTable table td {
                text-align: right;
            }

        #stockTable .loading td {
            text-align: left;
        }
    </style>
</head>
<body>
    <h1>WebSocket Test</h1>

    <!--<h2>Live Stock Table</h2>-->
    <div id="stockTable">
        <!--<table border="1">
            <thead>
            <tr><th>Symbol</th><th>Price</th><th>Open</th><th>Change</th><th>%</th></tr>
            </thead>
            <tbody>
            <tr class="loading"><td colspan="5">loading...</td></tr>
            </tbody>
        </table>-->
        <label>input securityIds you want to subscribe:</label>
        <br />
        <textarea id="subIds" style="width: 1000px; height: 80px">1_nc8Gjd8h&952njfhsnV&RBjt30nRFjg7</textarea>
        <br />
        <input type="button" onclick="subscribe()" value="Subscribe" />
        <br />
        <br />
        <label>Receiving:</label>
        <br />
        <textarea id="log" style="width: 1000px; height: 500px"></textarea>
        <br />
    </div>

    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="../Scripts/jquery-1.6.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="../Scripts/jquery.signalR-2.2.2.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="../signalr/hubs"></script>
    <!--Reference the StockTicker script. -->
    <script type="text/javascript">
        // A simple templating method for replacing placeholders enclosed in curly braces.
        if (!String.prototype.supplant) {
            String.prototype.supplant = function (o) {
                return this.replace(/{([^{}]*)}/g,
                    function (a, b) {
                        var r = o[b];
                        return typeof r === 'string' || typeof r === 'number' ? r : a;
                    }
                );
            };
        }

        function getQueryStringByName(name) {
            var result = location.search.match(new RegExp("[\?\&]" + name + "=([^\&]+)", "i"));
            if (result == null || result.length < 1) {
                return "";
            }
            return result[1];
        }

        var hub;

        function subscribe() {
            if (getQueryStringByName('live'))
                hub.server.SL($('#subIds').val());
            else
                hub.server.L($('#subIds').val());
        }

        $(function () {

            var ticker = $.connection.M, // the generated client-side hub proxy
                up = '▲',
                down = '▼',
                $stockTable = $('#stockTable'),
                $stockTableBody = $stockTable.find('tbody'),
                rowTemplate = '<tr data-symbol="{Symbol}"><td>{Symbol}</td><td>{Price}</td><td>{DayOpen}</td><td>{Direction} {Change}</td><td>{PercentChange}</td></tr>';

            function formatStock(stock) {
                return $.extend(stock, {
                    Price: stock.last.toFixed(2),
                    PercentChange: (stock.last*1.03 * 100).toFixed(2) + '%',
                    Direction: stock.Change === 0 ? '' : stock.Change >= 0 ? up : down
                });
            }

            function init() {
                //ticker.server.L('1_93b639d05e494aa2a629721119ddb228').done(
                //    function() {
                //        ticker.server.S('1,2,3');
                //    });
                //;

                //window.setInterval(function() {
                //ticker.server.S('20871,22577,20847,24964,20875');
                hub = ticker;

                //subscribe();
                //},100);
            }

            // Add a client-side hub method that the server will call
            ticker.client.p = function (stocks) {
                if (stocks && stocks.length > 0) {
                    var date = new Date();
                    $('#log').append(date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds() + "." + date.getMilliseconds() + " ");
                }

                $.each(stocks, function () {

                    //alert(this);

                    //var displayStock = formatStock(this),
                    //    $row = $(rowTemplate.supplant(displayStock));

                    //$stockTableBody.find('tr[data-symbol=' + stock.Symbol + ']')
                    //    .replaceWith($row);

                    $('#log').append(this.msgId + " " + this.posId + ', ');
                });

                if (stocks && stocks.length > 0) {
                    $('#log').append('\r\n');

                    var textarea = document.getElementById('log');
                    textarea.scrollTop = textarea.scrollHeight;
                }
            }

            // Start the connection
            $(function () {
                //alert();
                //$.connection.hub.qs = { 'auth': '1_93b639d05e494aa2a629721119ddb228' };
                $.connection.hub.start().done(init);

                ////websocket CORS test
                //$.connection.hub.url = 'http://192.168.20.111:11033/signalr/';
                //$.connection.hub.start().done(init);

                ////test web api CORS
                //$.ajax({
                //    url: 'http://192.168.20.111:11033/api/user/me',
                //    headers:
                //    {
                //        'Authorization':'Basic 9_083f416be4a64a15968841cdb75b60d1'
                //    }
                //}).done(
                //    function (data, textStatus, jqXHR) {
                //        debugger;
                //    }).fail(function (jqXHR, textStatus, errorThrown) {
                //    debugger;
                //});
            });
        });
    </script>
</body>
</html>